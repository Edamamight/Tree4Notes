<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ローカルメモアプリ</title>
  <style>
    body {
      font-family: "Helvetica", sans-serif;
      background-color: #fafafa;
      margin: 0;
      padding: 1rem;
      color: #333;
    }
    header {
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 {
      font-size: 1.2rem;
      margin: 0;
    }
    #feedSelector {
      padding: 0.25rem;
    }
    #controls, #filterArea {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    #noteList {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .note {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      padding: 1rem;
      position: relative;
    }
    .note .meta {
      font-size: 0.8rem;
      color: #777;
      margin-top: 0.5rem;
    }
    .note .quote {
      font-style: italic;
      color: #555;
      margin-top: 0.5rem;
    }
    .note .tree-indent {
      margin-left: 1.5rem;
      border-left: 2px dotted #ccc;
      padding-left: 1rem;
    }
    .note .button {
      cursor: pointer;
      font-size: 0.8rem;
      margin-left: 1rem;
      color: #007acc;
    }
    .note .delete {
      color: red;
      position: absolute;
      top: 0.5rem;
      right: 1rem;
      cursor: pointer;
    }
    #addNoteSection {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #ccc;
      padding: 1rem;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
    }
    #noteInput {
      width: 100%;
      font-size: 1rem;
      padding: 0.5rem;
    }
    button {
      font-size: 1rem;
      padding: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>メモアプリ</h1>
    <select id="feedSelector" onchange="switchFeed(this.value)">
      <option value="default">デフォルトフィード</option>
      <option value="work">仕事</option>
      <option value="personal">個人</option>
    </select>
  </header>

  <div id="controls">
    <select id="sortSelect" onchange="renderNotes()"> 
      <option value="newest">新しい順</option>
      <option value="oldest">古い順</option>
    </select>
    <input type="date" id="dateFilter" onchange="renderNotes()" />
    <input type="text" id="tagFilter" placeholder="#タグで絞り込み" oninput="renderNotes()" />
    <input type="text" id="searchInput" placeholder="検索..." oninput="renderNotes()" />
    <button onclick="exportNotes()">エクスポート</button>
    <button onclick="importNotes()">インポート</button>
    <input type="file" id="fileInput" style="display:none" />
  </div>

  <div id="noteList"></div>

  <div id="addNoteSection">
    <input type="text" id="noteInput" placeholder="メモを書く... #タグ >>ID @スレッド">
    <button onclick="addNote()">追加</button>
  </div>

  <script>
    let notes = [];
    let nextId = 0;
    let currentFeed = 'default';

    function addNote(replyTo = null) {
      const input = document.getElementById('noteInput');
      const text = input.value.trim();
      if (!text) return;

      const hashtags = text.match(/#\w+/g) || [];
      const quoteMatch = text.match(/>>\d+/);
      const thread = (text.match(/@\w+/) || [])[0] || '';

      notes.push({
        id: nextId++,
        text,
        hashtags,
        timestamp: new Date().toISOString(),
        quoteId: quoteMatch ? parseInt(quoteMatch[0].slice(2)) : null,
        thread,
        favorite: false,
        deleted: false,
        parentId: replyTo,
        feed: currentFeed
      });
      input.value = '';
      renderNotes();
    }

    function renderNotes() {
      const container = document.getElementById('noteList');
      const search = document.getElementById('searchInput').value.toLowerCase();
      const sort = document.getElementById('sortSelect').value;
      const tag = document.getElementById('tagFilter').value.toLowerCase();
      const date = document.getElementById('dateFilter').value;
      container.innerHTML = '';

      let filtered = notes.filter(n => !n.deleted && n.feed === currentFeed);

      if (search) {
        filtered = filtered.filter(n => n.text.toLowerCase().includes(search));
      }
      if (tag) {
        filtered = filtered.filter(n => n.hashtags.some(h => h.toLowerCase().includes(tag)));
      }
      if (date) {
        filtered = filtered.filter(n => n.timestamp.startsWith(date));
      }

      filtered.sort((a, b) => {
        return sort === 'oldest' ? a.id - b.id : b.id - a.id;
      });

      for (const note of filtered) {
        const div = document.createElement('div');
        div.className = 'note';
        const quote = note.quoteId !== null ? notes.find(n => n.id === note.quoteId)?.text || '' : '';
        const indentLevel = getIndentLevel(note);
        div.innerHTML = `
          <div class="delete" onclick="deleteNote(${note.id})">✕</div>
          ${quote ? `<div class="quote">引用 >>${note.quoteId}: ${quote}</div>` : ''}
          <div class="tree-indent" style="margin-left:${indentLevel * 2}rem">${note.text}</div>
          <div class="meta">ID:${note.id} ${new Date(note.timestamp).toLocaleString()} ${note.thread}</div>
          <div class="meta">タグ: ${note.hashtags.join(' ')}</div>
          <span class="button" onclick="addReply(${note.id})">補足</span>
        `;
        container.appendChild(div);
      }
    }

    function getIndentLevel(note, level = 0) {
      const parent = notes.find(n => n.id === note.parentId);
      return parent ? getIndentLevel(parent, level + 1) : level;
    }

    function addReply(id) {
      const replyText = prompt("補足を入力:");
      if (replyText) {
        document.getElementById("noteInput").value = replyText + ` >>${id}`;
        addNote(id);
      }
    }

    function deleteNote(id) {
      if (confirm("本当に削除しますか？")) {
        const note = notes.find(n => n.id === id);
        if (note) note.deleted = true;
        renderNotes();
      }
    }

    function exportNotes() {
      const blob = new Blob([JSON.stringify(notes)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "notes.json";
      a.click();
    }

    function importNotes() {
      document.getElementById('fileInput').click();
      document.getElementById('fileInput').onchange = function(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function() {
          try {
            const imported = JSON.parse(reader.result);
            notes = imported;
            nextId = Math.max(...notes.map(n => n.id)) + 1;
            renderNotes();
          } catch (e) {
            alert("読み込みに失敗しました");
          }
        };
        reader.readAsText(file);
      };
    }

    function switchFeed(feedName) {
      currentFeed = feedName;
      renderNotes();
    }
  </script>
</body>
</html>
